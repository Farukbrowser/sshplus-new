#!/bin/bash
# SSH Plus Multiport Firewall Fix
# This script opens the required firewall ports for multiport functionality

echo -e "\033[1;32m========================================\033[0m"
echo -e "\033[1;32m    SSH Plus Multiport Firewall Fix    \033[0m"
echo -e "\033[1;32m========================================\033[0m"
echo ""
echo -e "\033[1;33mThis script will open the required firewall ports for multiport functionality.\033[0m"
echo -e "\033[1;33mPorts to be opened: 80, 2082, 8080\033[0m"
echo ""
read -p "$(echo -e "\033[1;32mDo you want to continue? [y/N]: \033[0m")" confirm

if [[ $confirm != [yY] && $confirm != [yY][eE][sS] ]]; then
    echo -e "\033[1;31mOperation cancelled.\033[0m"
    exit 1
fi

echo ""
echo -e "\033[1;33mOpening firewall ports...\033[0m"

# Array of ports to open
ports=("80" "2082" "8080")

# Check if firewalld is running
if pgrep firewalld > /dev/null; then
    echo -e "\033[1;32mConfiguring firewalld...\033[0m"
    for port in "${ports[@]}"; do
        echo -e "\033[1;37m- Opening port $port/tcp\033[0m"
        sudo firewall-cmd --zone=public --add-port=$port/tcp
        sudo firewall-cmd --permanent --zone=public --add-port=$port/tcp
    done
    sudo firewall-cmd --reload
    echo -e "\033[1;32mFirewalld configuration completed.\033[0m"
fi

# Check if UFW is active
if [[ -f "/usr/sbin/ufw" ]] && ufw status | grep -q "Status: active"; then
    echo -e "\033[1;32mConfiguring UFW...\033[0m"
    for port in "${ports[@]}"; do
        echo -e "\033[1;37m- Opening port $port/tcp\033[0m"
        sudo ufw allow $port/tcp
    done
    echo -e "\033[1;32mUFW configuration completed.\033[0m"
fi

# Configure iptables if needed
if iptables -L -n | grep -qE 'REJECT|DROP'; then
    echo -e "\033[1;32mConfiguring iptables...\033[0m"
    for port in "${ports[@]}"; do
        echo -e "\033[1;37m- Opening port $port/tcp\033[0m"
        sudo iptables -I INPUT -p tcp --dport $port -j ACCEPT
    done
    echo -e "\033[1;32mIptables configuration completed.\033[0m"
fi

echo ""
echo -e "\033[1;32m========================================\033[0m"
echo -e "\033[1;32m           Fix Completed!               \033[0m"
echo -e "\033[1;32m========================================\033[0m"
echo ""
echo -e "\033[1;33mMultiport functionality should now work properly.\033[0m"
echo -e "\033[1;33mYou can now use ports 80,2082,8080 in multiport configuration.\033[0m"
echo ""
echo -e "\033[1;37mTo test multiport, go to SSH Plus menu and configure:\033[0m"
echo -e "\033[1;37m- SOCKS Proxy or WebSocket with ports: 80,2082,8080\033[0m"
echo ""